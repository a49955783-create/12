<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📌 نموذج استلام العمليات — OCR + كشف اللون (جاهز GitHub/Vercel)</title>
  <style>
    body{font-family: -apple-system, system-ui, "Segoe UI", Tahoma, Arial, "Noto Naskh Arabic UI", "Noto Kufi Arabic", sans-serif; margin:0; background:#f7f7f8; color:#0f172a}
    .wrap{max-width: 980px; margin: 24px auto; padding: 16px;}
    .card{background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:18px; box-shadow:0 6px 24px rgba(0,0,0,.05); margin-bottom:14px;}
    h1{margin:0 0 8px; font-size:clamp(18px,3vw,24px)}
    .muted{color:#64748b; font-size:13px}
    label{font-size:13px; color:#64748b; display:block; margin-bottom:6px}
    input, textarea, select, button{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; font-size:14px}
    textarea{min-height:110px; resize:vertical}
    button{cursor:pointer; background:#0f172a; color:#fff}
    button.ghost{background:#fff; color:#0f172a; border-color:#cbd5e1}
    .row{display:grid; gap:12px}
    @media (min-width:760px){ .row-2{grid-template-columns: 1fr 1fr;} }
    .out{white-space: pre-wrap; border:1px dashed #e5e7eb; background:#fff; border-radius:14px; padding:14px; line-height:1.9}
    .drop{border:2px dashed #cbd5e1; border-radius:14px; padding:16px; text-align:center; background:#fafafa}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{display:flex; gap:8px; align-items:center; padding:8px; border:1px solid #e5e7eb; border-radius:12px; background:#fff}
    .item input[type='text']{flex:1}
    .flex{display:flex; gap:10px; flex-wrap:wrap}
    .img{max-width:100%; border-radius:12px}
    .small{font-size:12px; color:#64748b}
    canvas{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>🧭 نموذج استلام العمليات — OCR + كشف اللون</h1>
      <div class="muted">
        • ارفع صورة أو الصقها (Ctrl+V) لاستخراج الأسماء والأكواد تلقائيًا. <br>
        • النظام يحدد الحالة من لون النقطة بجانب كل اسم: أخضر=في الميدان، بنفسجي=مشغول، أحمر=خارج الخدمة. <br>
        • الإخراج النهائي بدون ألوان (نص فقط). المستلم يُحتسب ضمن العدد ولا يُعرض ضمن الأسماء.
      </div>
    </div>

    <div class="card">
      <div class="row row-2">
        <div>
          <label for="recipient">المستلم</label>
          <input id="recipient" placeholder="اكتب اسم المستلم">
        </div>
        <div>
          <label for="deputy">النائب</label>
          <input id="deputy" placeholder="اكتب اسم النائب">
        </div>
      </div>

      <div style="margin-top:10px" class="row row-2">
        <div>
          <label>📷 ارفع صورة</label>
          <input id="imgInput" type="file" accept="image/*">
        </div>
        <div>
          <label>أو ألصق صورة هنا (Ctrl+V)</label>
          <div id="drop" class="drop">الصق صورة هنا أو اسحبها وأفلِتها</div>
        </div>
      </div>

      <div id="previewWrap" style="margin-top:10px; display:none">
        <img id="preview" class="img" alt="image preview">
        <div class="small">تم تحميل الصورة — اضغط «استخراج من الصورة» لقراءة الأسماء وتحديد الحالة من اللون.</div>
        <canvas id="cvs"></canvas>
      </div>

      <div class="flex" style="margin-top:10px">
        <button id="extract">استخراج من الصورة (OCR)</button>
        <button class="ghost" id="clear">إعادة تعيين</button>
      </div>
      <div id="progress" class="small" style="margin-top:8px; display:none"></div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:8px">القائمة المستخرجة (يمكن تعديل الحالة يدويًا):</div>
      <div id="list" class="list"></div>
    </div>

    <div class="card">
      <div class="flex">
        <button id="generate">توليد النص النهائي</button>
        <button class="ghost" id="copyAr">نسخ النص العربي</button>
      </div>
      <div id="outAr" class="out" dir="rtl" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Tesseract.js (OCR) -->
  <script src="https://unpkg.com/tesseract.js@v5/dist/tesseract.min.js"></script>
  <script>
    // State
    let people = []; // { name, code, status: 'field' | 'busy' | 'oos', bbox }
    let imageBlobUrl = null;
    let imgEl = null;
    let canvas = null, ctx = null;

    const $ = (id)=>document.getElementById(id);
    const drop = $("drop");
    const previewWrap = $("previewWrap");
    const preview = $("preview");
    const progress = $("progress");
    const copyBtn = $("copyAr");

    // Helpers
    function parseNameCode(text){
      text = text.replace(/[🟢🟣🔴●•■□▪▫◦]/g, "").trim();
      const m = text.match(/^(.*?)[\s\-–]+([A-Za-z]{1,4}-?\d{1,4})$/);
      if(m){
        return { name: m[1].trim(), code: m[2].trim() };
      }
      return { name: text, code: "" };
    }

    function hsvFromRgb(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h,s,v=max;
      const d=max-min;
      s=max===0?0:d/max;
      if(max===min){ h=0; }
      else{
        switch(max){
          case r: h=(g-b)/d + (g<b?6:0); break;
          case g: h=(b-r)/d + 2; break;
          case b: h=(r-g)/d + 4; break;
        }
        h/=6;
      }
      return { h: h*360, s, v };
    }

    function classifyHue(avg){
      if(avg.s < 0.35 || avg.v < 0.3) return "unknown";
      const h = avg.h;
      if((h >= 70 && h <= 170)) return "green";
      if((h >= 260 && h <= 320)) return "purple";
      if(h <= 20 || h >= 340) return "red";
      return "unknown";
    }

    function sampleColorNearBBox(b){
      if(!ctx) return "unknown";
      const w = canvas.width, h = canvas.height;
      const x0 = Math.max(0, b.x0|0), x1 = Math.min(w-1, b.x1|0);
      const y0 = Math.max(0, b.y0|0), y1 = Math.min(h-1, b.y1|0);
      const lineH = Math.max(1, y1-y0);
      const pad = Math.floor(lineH * 0.2);
      const boxW = Math.max(8, Math.floor(lineH * 0.8));
      const midY = Math.floor((y0+y1)/2);

      function avgHSV(sx, sy, ex, ey){
        sx=Math.max(0,sx); sy=Math.max(0,sy); ex=Math.min(w-1,ex); ey=Math.min(h-1,ey);
        if(ex<=sx || ey<=sy) return {h:0,s:0,v:0,count:0};
        const data = ctx.getImageData(sx, sy, ex-sx, ey-sy).data;
        let sumH=0, sumS=0, sumV=0, cnt=0;
        for(let i=0;i<data.length;i+=4){
          const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
          if(a<10) continue;
          const hsv=hsvFromRgb(r,g,b);
          if(hsv.s>0.5 && hsv.v>0.35){
            sumH+=hsv.h; sumS+=hsv.s; sumV+=hsv.v; cnt++;
          }
        }
        if(cnt===0) return {h:0,s:0,v:0,count:0};
        return {h:sumH/cnt, s:sumS/cnt, v:sumV/cnt, count:cnt};
      }

      const rightBox = { sx: x1 + pad, sy: midY - Math.floor(boxW/2), ex: x1 + pad + boxW, ey: midY + Math.floor(boxW/2) };
      let avg = avgHSV(rightBox.sx, rightBox.sy, rightBox.ex, rightBox.ey);
      let cls = classifyHue(avg);
      if(cls!=="unknown") return cls;

      const leftBox = { sx: x0 - pad - boxW, sy: midY - Math.floor(boxW/2), ex: x0 - pad, ey: midY + Math.floor(boxW/2) };
      avg = avgHSV(leftBox.sx, leftBox.sy, leftBox.ex, leftBox.ey);
      cls = classifyHue(avg);
      if(cls!=="unknown") return cls;

      const innerBox = { sx: x1 - boxW, sy: midY - Math.floor(boxW/2), ex: x1, ey: midY + Math.floor(boxW/2) };
      avg = avgHSV(innerBox.sx, innerBox.sy, innerBox.ex, innerBox.ey);
      cls = classifyHue(avg);
      return cls;
    }

    function renderList(){
      const list = $("list");
      list.innerHTML = "";
      people.forEach((p, idx)=>{
        const wrapper = document.createElement("div");
        wrapper.className = "item";
        wrapper.innerHTML = `
          <input type="text" value="${p.name}" aria-label="name" data-k="name" />
          <input type="text" value="${p.code}" aria-label="code" style="max-width:120px" data-k="code" placeholder="الكود" />
          <select data-k="status" style="max-width:180px">
            <option value="field" ${p.status==='field'?'selected':''}>في الميدان</option>
            <option value="busy" ${p.status==='busy'?'selected':''}>مشغول</option>
            <option value="oos" ${p.status==='oos'?'selected':''}>خارج الخدمة</option>
          </select>
        `;
        wrapper.querySelectorAll("input,select").forEach(el=>{
          el.addEventListener("input", ()=> people[idx][el.dataset.k] = el.value );
          el.addEventListener("change", ()=> people[idx][el.dataset.k] = el.value );
        });
        list.appendChild(wrapper);
      });
    }

    function generateOutput(){
      const recipient = $("recipient").value.trim();
      const deputy = $("deputy").value.trim();

      const inField = people.filter(p=>p.status!=='oos');
      const oos = people.filter(p=>p.status==='oos');

      const totalField = inField.length + (recipient ? 1 : 0);

      const namesList = inField.map(p => `- ${p.name}${p.code? ' ' + p.code : ''}${p.status==='busy' ? ' (مشغول)' : ''}`).join("\n");

      let text = `📌 استلام العمليات 📌

المستلم : ${recipient}

النائب : ${deputy}

عدد و اسماء الوحدات الاسعافيه في الميدان : {${totalField}}
${namesList}

خارج الخدمه : (${oos.length})

🎙️ تم استلام العمليات و جاهزون للتعامل مع البلاغات

الملاحظات : تحديث`;

      $("outAr").textContent = text;
    }

    copyBtn.addEventListener("click", async()=>{
      const txt = $("outAr").textContent || "";
      if(!txt) { alert("لا يوجد نص لنسخه."); return; }
      try{
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = "تم النسخ ✅";
        setTimeout(()=>copyBtn.textContent="نسخ النص العربي", 1500);
      }catch(e){
        alert("تعذّر النسخ تلقائيًا. حدّد النص وانسخه يدويًا.");
      }
    });

    function prepareCanvasFromImg(){
      const canvasEl = $("cvs");
      const context = canvasEl.getContext("2d", { willReadFrequently: true });
      canvasEl.width = preview.naturalWidth;
      canvasEl.height = preview.naturalHeight;
      context.drawImage(preview, 0, 0);
      canvas = canvasEl; ctx = context;
    }

    $("imgInput").addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      if(imageBlobUrl) URL.revokeObjectURL(imageBlobUrl);
      imageBlobUrl = URL.createObjectURL(file);
      preview.onload = ()=>{ previewWrap.style.display = ""; prepareCanvasFromImg(); };
      preview.src = imageBlobUrl;
    });

    window.addEventListener("paste", (e)=>{
      const items = e.clipboardData?.items || [];
      for(const it of items){
        if(it.type.startsWith("image/")){
          const file = it.getAsFile();
          if(imageBlobUrl) URL.revokeObjectURL(imageBlobUrl);
          imageBlobUrl = URL.createObjectURL(file);
          preview.onload = ()=>{ previewWrap.style.display = ""; prepareCanvasFromImg(); };
          preview.src = imageBlobUrl;
          e.preventDefault();
          break;
        }
      }
    });

    ;["dragover","drop"].forEach(ev=>drop.addEventListener(ev, e=>e.preventDefault()));
    drop.addEventListener("drop", (e)=>{
      const file = e.dataTransfer?.files?.[0];
      if(file && file.type.startsWith("image/")){
        if(imageBlobUrl) URL.revokeObjectURL(imageBlobUrl);
        imageBlobUrl = URL.createObjectURL(file);
        preview.onload = ()=>{ previewWrap.style.display = ""; prepareCanvasFromImg(); };
        preview.src = imageBlobUrl;
      }
    });

    $("extract").addEventListener("click", async()=>{
      if(!imageBlobUrl){ alert("الرجاء إضافة صورة أولاً (رفع، لصق، أو سحب وإفلات)."); return; }
      progress.style.display = "";
      progress.textContent = "جاري قراءة النص من الصورة…";
      try{
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('ara+eng');
        await worker.initialize('ara+eng');
        const { data } = await worker.recognize(imageBlobUrl, { tessedit_char_blacklist: '•●◦▪■□' });
        await worker.terminate();

        const lines = data.lines || data.words?.map(w=>({ text: w.text, bbox: w.bbox })) || [];
        people = [];
        for(const line of lines){
          const txt = (line.text || "").trim();
          if(!txt) continue;
          if(!(/[\u0600-\u06FF]/.test(txt))) continue;

          const { name, code } = parseNameCode(txt);
          if(!name) continue;

          const bbox = line.bbox || line;
          const cls = sampleColorNearBBox(bbox);
          let status = "field";
          if(cls === "purple") status = "busy";
          else if(cls === "red") status = "oos";
          else status = "field";

          people.push({ name, code, status, bbox });
        }

        const unique = new Map();
        for(const p of people){
          const key = (p.name + "|" + p.code).trim();
          if(!unique.has(key)) unique.set(key, p);
        }
        people = Array.from(unique.values());

        renderList();
        progress.textContent = "تم استخراج الأسماء وتحديد الحالات من اللون. يمكنك تعديلها ثم توليد النص.";
      }catch(err){
        console.error(err);
        alert("حصل خطأ أثناء القراءة. جرّب صورة أوضح أو قصّ الجزء المطلوب.");
        progress.textContent = "";
      }
    });

    $("generate").addEventListener("click", generateOutput);

    $("clear").addEventListener("click", ()=>{
      people = [];
      renderList();
      $("recipient").value = "";
      $("deputy").value = "";
      $("outAr").textContent = "";
      if(imageBlobUrl) URL.revokeObjectURL(imageBlobUrl);
      imageBlobUrl = null;
      preview.src = "";
      previewWrap.style.display = "none";
      progress.style.display = "none";
      $("imgInput").value = "";
    });
  </script>
</body>
</html>
